import { Contributors } from '@/components/Contributors'
import { Resources } from '@/components/Resources'
import { Guides } from '@/components/Guides'

export const description =
  'Neste guia, falaremos sobre o que acontece quando algo d√° errado enquanto voc√™ trabalha com a API.'

# Events

√Äs vezes, os usu√°rios enviam mensagens como uma imagem, um v√≠deo ou mensagens de localiza√ß√£o especial, entre outras, para receber e iniciar uma conversa quando chega uma mensagem desse tipo, podemos usar os eventos.

```mermaid
flowchart BT
    a(User)-.->eW((Welcome))-.->b[(BOT)]
    s(User)-.->eM((Image/Video))-.->b[(BOT)]
    c(User)-.->eD((Document))-.->b[(BOT)]
    d(User)-.->eL((Location))-.->b[(BOT)]
    e(User)-.->eV((Voice Note))-.->b[(BOT)]
```

---

## Default  {{ tag: 'WELCOME'  }}

Quando um usu√°rio envia uma mensagem de" texto " que n√£o existe em uma palavra-chave em outro fluxo, o evento de boas-vindas ser√° acionado por padr√£o, que √© o evento padr√£o.

Vamos imaginar o caso em que uma pessoa escreve a palavra `Thank you!`

<CodeGroup>
```ts {{ title: 'app.ts' }}
  import { addKeyword, EVENTS } from '@builderbot/bot'
  
  const welcomeFlow = addKeyword(EVENTS.WELCOME).addAnswer('Ey welcome?')
  const greetingFlow = addKeyword(['hello','hi']).addAnswer('Hi!')
```
```js {{ title: 'app.js' }}
  const { addKeyword, EVENTS } = require('@builderbot/bot')
  
  const welcomeFlow = addKeyword(EVENTS.MEDIA).addAnswer('Message hello')
```
</CodeGroup>

<RowCenter>
  <Col>
  ```mermaid
flowchart TB
    A(User) --"Thank you!"--> B((BOT))
    B --> C[Flows]
    C --> G["welcomeFlow"]
    G -. Ey welcome? .-> A

  style B fill:#fff2b2,stroke:#ffee99,stroke-width:2px
  style G fill:#b2f7ef,stroke:#9ceaef,stroke-width:2px
```
  </Col>
  <Col>
```mermaid
flowchart TB
    A(User) --"hello"--> B((BOT))
    B --> C[Flows]
    C --> G["greetingFlow"]
    G -. Hi .-> A

  style B fill:#fff2b2,stroke:#ffee99,stroke-width:2px
  style G fill:#b2f7ef,stroke:#9ceaef,stroke-width:2px
```
  </Col>
</RowCenter>

Podemos ver no diagrama acima que o bot faz uma pesquisa em todos os fluxos para obter o melhor fluxo que pode responder √† palavra-chave "Obrigado", mas como n√£o encontra o "WELCOME" √© acionado.

---

## Received Image or Video {{ tag: 'MEDIA'  }}

Quando um usu√°rio envia uma imagem ou um v√≠deo, o evento de m√≠dia, que √© o evento padr√£o, ser√° acionado por padr√£o. Isto √© ideal para quando precisamos que eles enviem informa√ß√µes e precisamos armazen√°-las.

<CodeGroup>
```ts {{ title: 'app.ts' }}
  import { addKeyword, EVENTS } from '@builderbot/bot'
  
  const mediaFlow = addKeyword(EVENTS.MEDIA).addAnswer('I received a media image/video')
```
```js {{ title: 'app.js' }}
  const { addKeyword, EVENTS } = require('@builderbot/bot')
  
  const mediaFlow = addKeyword(EVENTS.MEDIA).addAnswer('I received a media image/video')
```
</CodeGroup>

<Note>
Para salvar o arquivo de m√≠dia, voc√™ deve invocar a fun√ß√£o saveFile do provedor que est√° usando.
</Note>

<CodeGroup>
```ts {{ title: 'app.ts' }}
  import { addKeyword, EVENTS } from '@builderbot/bot'
  import { BaileysProvider } from '@builderbot/provider-baileys'

  const mediaFlow = addKeyword<BaileysProvider>(EVENTS.MEDIA)
  .addAnswer('I received a media image/video', async (ctx, { provider }) => {
    const localPath = await provider.saveFile(ctx, {path:'...'})
    //console.log(localPath)
  })
```
```js {{ title: 'app.js' }}
  const { addKeyword, EVENTS } = require('@builderbot/bot')
  const { BaileysProvider } = require('@builderbot/bot')
  
  const mediaFlow = addKeyword(EVENTS.MEDIA)
  .addAnswer('I received a media image/video', async (ctx, { provider }) => {
    const localPath = await provider.saveFile(ctx, {path:'...'})
    //console.log(localPath)
  })
```
</CodeGroup>

---

## Received Document {{ tag: 'DOCUMENT'  }}

Quando um usu√°rio envia um documento, o evento DOCUMENT ser√° acionado por padr√£o, que √© o evento padr√£o.
<CodeGroup>
```ts {{ title: 'app.ts' }}
  import { addKeyword, EVENTS } from '@builderbot/bot'
  
  const documentFlow = addKeyword(EVENTS.DOCUMENT)
  .addAnswer("Wow! I'm sorry I can't read this document right now", async (ctx, { provider }) => {
    const localPath = await provider.saveFile(ctx, {path:'...'})
    //console.log(localPath)
  })
```
```js {{ title: 'app.js' }}
  const { addKeyword, EVENTS } = require('@builderbot/bot')
  
  const documentFlow = addKeyword(EVENTS.DOCUMENT)
  .addAnswer("Wow! I'm sorry I can't read this document right now", async (ctx, { provider }) => {
    const localPath = await provider.saveFile(ctx, {path:'...'})
    //console.log(localPath)
  })
```
</CodeGroup>

---

## Received Location {{ tag: 'LOCATION'  }}

<Note>
A localiza√ß√£o deve ser enviada via WhatsApp, ainda n√£o permite links de localiza√ß√£o de aplicativos externos
</Note>
Quando Seu chatbot precisa acessar a localiza√ß√£o de um usu√°rio, √© importante garantir que o local seja enviado diretamente do aplicativo WhatsApp para obter resultados. Uma vez que o lugar √© recebido, voc√™ pode executar um log de console de ctx para ver os detalhes do lugar recebido.

O contexto de localiza√ß√£o recebido ser√° algo como isto em console:

```bash
ctx:  {
  ...
  message: Message {
    locationMessage: LocationMessage {
      degreesLatitude: -2.1462137699127197,
      degreesLongitude: -79.88981628417969,
      name: 'Doctor Miguel Angel Jij√≥n Teran',
      address: 'Doctor Miguel Angel Jij√≥n Teran, Guayaquil, Ecuador',
    },
  },
  body: '_event_location__0d5c9f57-0909-44a1-995f-902f9df3b21f',
  name: 'yeyodev üë®üèæ‚Äçüíª',
  from: '593000000000'
}
```
Isso exibir√° a latitude e a longitude do usu√°rio no console, permitindo que voc√™ utilize efetivamente os dados de localiza√ß√£o para a funcionalidade do seu chatbot.

Para aceder aos dados de localiza√ß√£o, pode utilizar a seguinte abordagem:

<CodeGroup>
```ts {{ title: 'location.flow.ts' }}
import { EVENTS, addKeyword } from "@builderbot/bot";

export default addKeyword(EVENTS.LOCATION)
.addAnswer("I have received your location!", null, async (ctx) => {
  const userLatitude = ctx.message.locationMessage.degreesLatitude;
  const userLongitude = ctx.message.locationMessage.degreesLongitude;
})
```
```js {{ title: 'location.flow.js' }}
const { EVENTS, addKeyword } = require("@builderbot/bot");

export default addKeyword(EVENTS.LOCATION)
.addAnswer("I have received your location!", null, async (ctx) => {
  const userLatitude = ctx.message.locationMessage.degreesLatitude;
  const userLongitude = ctx.message.locationMessage.degreesLongitude;
})
```
</CodeGroup>

---

## Received Voice Note {{ tag: 'VOICE_NOTE' }}

Quando um utilizador envia uma nota de voz, o VOICE_NOTE evento ser√° acionado por padr√£o, que √© o evento destinado a esse comportamento, √© importante entender que uma nota de voz √© diferente de um arquivo de imagem ou v√≠deo.

<CodeGroup>
```ts {{ title: 'app.ts' }}
  import { addKeyword, EVENTS } from '@builderbot/bot'
  
  const voiceNoteFlow = addKeyword(EVENTS.VOICE_NOTE)
  .addAnswer('Give me a second to hear you!', async (ctx, { provider }) => {
    const localPath = await provider.saveFile(ctx, {path:'...'})
    //console.log(localPath)
  })
  
```
```js {{ title: 'app.js' }}
  const { addKeyword, EVENTS } = require('@builderbot/bot')
  
  const voiceNoteFlow = addKeyword(EVENTS.VOICE_NOTE)
  .addAnswer('Give me a second to hear you!', async (ctx, { provider }) => {
    const localPath = await provider.saveFile(ctx, {path:'...'})
    //console.log(localPath)
  })
```
</CodeGroup>

---

<Guides />

<Resources />

<Contributors users={['leifermendez', 'elimeleth']} />