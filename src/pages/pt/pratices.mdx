export const description = 'Neste guia, falaremos sobre o que acontece quando algo d√° errado enquanto voc√™ trabalha com a API.'

# Pr√°ticas

A biblioteca baseia-se em tr√™s componentes fundamentais para o seu correcto funcionamento: o Flow, encarregado de construir o contexto da conversa e de oferecer uma interface amig√°vel ao programador; o provedor, que atua como um conector que permite alternar facilmente entre os provedores do WhatsApp sem o risco de afetar outras partes do bot; e o banco de dados, que est√° de acordo com essa filosofia de conector, facilita a altera√ß√£o da camada de persist√™ncia de dados sem a necessidade de reescrever o fluxo de trabalho.

---

## Hist√≥rico de conversa√ß√£o {{ tag: 'state'  }}

Muitas vezes, precisaremos gerenciar conversas e manter o contexto em uma mem√≥ria chamada `state` que √© vol√°til e acess√≠vel a partir de qualquer fun√ß√£o executada em um stream.


```ts 
  const welcomeFlow = addKeyword(['ol√°'])
      .addAction(
          "Qual √© o seu nome?",
          {captura: true},
          async (ctx, { flowDynamic, state }) => {
              await state.update({ nome: ctx.body })
              esperar flowDynamic ('Obrigado por me dar o seu nome!')
          }
      )
      .addAction(
          'Quantos anos voc√™ tem?',
           {captura: true},
          async (ctx, { flowDynamic, state }) => {
              const name = state.get('nome')
              await state.update({ age: ctx.body })
              await flowDynamic(`Obrigado por compartilhar sua idade! ${name}`)
          }
      )
      .addAction('Aqui est√£o seus dados:', null, async (_, { flowDynamic, state }) => {
          const myState = state.getMyState()
          await flowDynamic(`Nome: ${myState.name} Idade: ${myState.age}`)
      })
```



---

## Mensagens Din√¢micas {{ tag: 'flowDynamic'  }}

Em outras ocasi√µes, precisamos enviar mensagens de forma din√¢mica de dados que podem ser vari√°veis, abaixo voc√™ pode ver um exemplo de como voc√™ deve faz√™-lo e como voc√™ n√£o deve faz√™-lo.

<Error>
 ‚ùå Evite isso, n√£o funciona porque addAnswer serializa o conte√∫do no in√≠cio da execu√ß√£o.
</Error>

```ts
const nome = ''

const flow = addKeyword('ol√°')
    .addAction(`Qual √© o seu nome? `, { capture: true }, async (ctx) => {
        nome = ctx.body
    })
    .addAnswer(`Seu nome √©: ${name}`)
```
<Note>
Se voce quiser enviar uma mensagem dinamico use flowDynamic
</Note>

```ts
const flow = addKeyword('ol√°')
    .addAction(`Qual √© o seu nome? `, { capture: true }, async (ctx, { state }) => {
        await state.update({ nome: ctx.body })
    })
    .addAction(async (ctx, { state, flowDynamic }) => {
        const name = state.get('nome')
        await flowDynamic(`Seu nome √©: ${name}`)
    })
```

---

## Enviar arquivo

Quando voc√™ deseja enviar uma imagem, √°udio, arquivo ou qualquer outro arquivo, voc√™ pode faz√™-lo desta forma. √â __important___ notar que a URL deve ser ___publicamente accessible__.

```ts
const flow = addKeyword('ol√°')
    .addAction(`Enviar imagem de URL`, 
        { media: 'https://i.imgur.com/0HpzsEm.png' }
    )
    .addAction(`Enviar v√≠deo de URL`, 
        { media: 'https://media.giphy.com/media/KWKwdBC2ODWlQ8kgt/giphy.mp4' }
    )
    .addAction(`Enviar arquivo de URL`, 
        { media: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf' }
    )
```

Outras maneiras de usar quando a rota vem de uma fonte de dados din√¢mica

```ts
const flow = addKeyword('ol√°')
    .addAction(async (_,{flowDynamic}) => {
        // ...db obter fonte...
        await flowDynamic([Tradu√ß√£o
            {body:'Esta √© uma imagem', media:'https://i.imgur.com/0HpzsEm.png'}
        ])
        await flowDynamic([Tradu√ß√£o
            {body:'Este √© um v√≠deo', media:'https://media.giphy.com/media/KWKwdBC2ODWlQ8kgt/giphy.mp4'}
        ])
    })

```
Se precisar de enviar um ficheiro que esteja armazenado localmente, tamb√©m o poder√° fazer. A utiliza√ß√£o de `join` √© recomendada para garantir a concatena√ß√£o correcta do direct√≥rio.

```ts
const flow = addKeyword('ol√°')
    .addAction(async (_,{flowDynamic}) => {
        const pathLocal = join('assets','doc.pdf')
        // pathLocal = c:/doc.pdf
        await flowDynamic([Tradu√ß√£o
            {body:'Este √© um v√≠deo', media: pathLocal }
        ])
    })

```

---

## Mudar para outro fluxo {{ tag: 'gotoFlow'  }}

Se quiser desviar um fluxo de conversa√ß√£o para outro fluxo l√≥gico baseado numa entrada de resposta, poder√° faz√™-lo da seguinte forma:

```ts

const flowToA = addKeyword(EVENTS.ACTION).addAnswer('Aqui temos a op√ß√£o A!')
const flowToB = addKeyword(EVENTS.ACTION).addAnswer('Aqui temos a op√ß√£o B!')
const flowToC = addKeyword(EVENTS.ACTION).addAnswer('Aqui temos a op√ß√£o C!')

const flowDefault = addKeyword(EVENTS.ACTION).addAnswer("N√£o temos essa op√ß√£o ü§î")

const flow = addKeyword('ordem')
    .addAction(
        [
            `Qual √© a melhor op√ß√£o para voc√™? `,
            `Tipo **A**`,
            `Tipo **B**`,
            `Tipo **C**`,
        ], 
        { captura: true }
    )
    .addAction(`Obrigado por responder`,async (ctx, {gotoFlow})=> {
        const userAnswer = ctx.body
        if(userAnswer === 'A'){
            return gotoFlow(flowToA)
        } 
        if(userAnswer === 'B'){
            return gotoFlow(flowToB)
        } 
        if(userAnswer === 'C'){
            return gotoFlow(flowToC)
        } 
        return gotoFlow(flowDefault)

    })
    .addAnswer(`esta mensagem n√£o ser√° enviada`)
```

---

## Desative o bot de um determinado usu√°rio {{ tag: 'state'  }}

√Äs vezes, precisaremos desligar o bot para um determinado usu√°rio, para que possamos conversar com o cliente sem que o bot interfira.

```ts
const flow = addKeyword<BaileysProvider>('palavra-chave m√°gica')
  .addAction(async (_, { state, endFlow }) => {
      const botOffForThisUser = state.get<boolean>('botOffForThisUser')
      if(botOffForThisUser) retorna endFlow()
  })
  .addAnswer('Ol√°!')
```

---

## Desativar para todos {{ tag: 'state'  }}

√Äs vezes precisaremos desativar o bot para todas as pessoas, sem a necessidade de desligar o servidor ou parar o script.

```ts
const flow = addKeyword<BaileysProvider>('botoff')
  .addAction(async (_, { globalState, endFlow }) => {
      const botOffForEveryOne = globalState.get<boolean>('botOffForEveryOne')
      if(botOffForEveryOne) return endFlow()
  })
  .addAnswer('Ol√°!')
```

---